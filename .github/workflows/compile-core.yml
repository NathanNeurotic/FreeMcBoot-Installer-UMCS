name: Build and Release

on:
  push:
    branches:
      - Tuna

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up PS2SDK environment
        uses: ps2homebrew/setup-ps2dev@v1

      - name: Build project
        run: |
          cd installer
          make clean
          make

      - name: Prepare artifacts
        run: |
          mkdir -p release_artifacts
          cp installer/FreeMcBoot-Installer.elf release_artifacts/FreeMcBoot-Installer.elf

      - name: Repackage full source tree
        run: |
          7z a release_artifacts/PS2-Exploits-Installer-${{ github.sha }}.zip ./installer ./installer_res ./mbr ./README.md ./Changelog.md
          7z a release_artifacts/PS2-Exploits-Installer-${{ github.sha }}.7z ./installer ./installer_res ./mbr ./README.md ./Changelog.md
          tar -czf release_artifacts/PS2-Exploits-Installer-${{ github.sha }}.tar.gz ./installer ./installer_res ./mbr ./README.md ./Changelog.md

      - name: Generate changelog
        run: |
          LOG_BODY="$(git log --pretty=format:'- %s (%h) by %an' -n 10)"
          echo 'RELEASE_BODY<<EOF' >> $GITHUB_ENV
          echo "$LOG_BODY" >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Create release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "Tuna"
          prerelease: false
          title: "PS2-Exploits-Installer"
          files: |
            release_artifacts/PS2-Exploits-Installer-${{ github.sha }}.zip
            release_artifacts/PS2-Exploits-Installer-${{ github.sha }}.7z
            release_artifacts/PS2-Exploits-Installer-${{ github.sha }}.tar.gz
          body: |
            PS2BBL and/or OpenTuna AIO Installer.

            Includes support for:
            - OpenTuna exploit icon install with ROM-based selection
            - PS2BBL + OSDMenu options
            - Auto-deletes conflicting Tuna folders
            - Timestamps: 12/31/2099 for compatibility

            ### Recent Changes:
            ${{ env.RELEASE_BODY }}
